<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¨æˆ¿ MVP</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 40px auto; padding: 0 16px; }
    input, button { font-size: 16px; padding: 10px; }
    input { width: 100%; box-sizing: border-box; margin: 8px 0; }
    button { cursor: pointer; margin-right: 8px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin-top: 16px; }
    .row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .result { font-size: 18px; font-weight: bold; margin-top: 8px; }
    .hint { color: #666; font-size: 14px; margin-top: 8px; }
    ul { padding-left: 18px; }
    li { margin: 8px 0; line-height: 1.4; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border: 1px solid #eee; padding: 8px; text-align: left; }
    .small { font-size: 13px; color: #666; }
    .pill { display: inline-block; padding: 2px 8px; border: 1px solid #ddd; border-radius: 999px; margin-left: 6px; font-size: 12px; color: #333; }
  </style>
</head>

<body>
  <h1>å¨æˆ¿ MVPï¼ˆ1.å½•å…¥ 2.æ¨è 3.å‡åº“å­˜ï¼‰</h1>

  <div class="card">
    <h2>è¯­éŸ³åŠ©æ‰‹ï¼ˆä¸­æ–‡ï¼‰</h2>
    <button id="micBtn">ğŸ™ï¸ æŒ‰æˆ‘è¯´è¯</button>
    <button id="stopBtn">åœæ­¢</button>
    <div class="small">æç¤ºï¼šChrome/Edge æœ€ç¨³å®šã€‚ç¬¬ä¸€æ¬¡éœ€è¦å…è®¸éº¦å…‹é£æƒé™ã€‚</div>
    <div style="margin-top:10px;">
      <div class="small"><b>ç”¨æˆ·è¯´ï¼š</b><span id="userUtter"></span></div>
      <div class="small"><b>AIï¼š</b><span id="aiUtter"></span></div>
    </div>
  </div>
  
  <!-- 1) å†™å…¥åº“å­˜ -->
  <div class="card">
    <h2>â‘  å½•å…¥å†°ç®±åº“å­˜ </h2>

    <div class="row">
      <div>
        <label>é£Ÿæåç§°</label>
        <input id="invName" placeholder="ä¾‹å¦‚ï¼šé¸¡è›‹" />
      </div>
      <div>
        <label>æ•°é‡ï¼ˆæ•´æ•°ï¼‰</label>
        <input id="invQty" placeholder="ä¾‹å¦‚ï¼š6" />
      </div>
      <div>
        <label>ä¿è´¨æœŸï¼ˆæ—¥æœŸï¼‰</label>
        <input id="invExp" type="date" />
      </div>
    </div>

    <button id="addInvBtn">æ·»åŠ /æ›´æ–°åº“å­˜</button>
    <button id="clearInvBtn">æ¸…ç©ºåº“å­˜</button>
    <span class="small">æç¤ºï¼šåŒåé£Ÿæä¼šåˆå¹¶æ•°é‡ï¼Œå¹¶ç”¨æ›´è¿‘çš„åˆ°æœŸæ—¥ä½œä¸ºè¯¥é£Ÿæåˆ°æœŸæ—¥ã€‚</span>

    <div id="invStatus" class="hint"></div>

    <h3 style="margin-top:14px;">å½“å‰åº“å­˜</h3>
    <table>
      <thead>
        <tr>
          <th>é£Ÿæ</th>
          <th>æ•°é‡</th>
          <th>åˆ°æœŸæ—¥</th>
          <th>å‰©ä½™å¤©æ•°</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="invTableBody"></tbody>
    </table>
  </div>

  <!-- 2) æ¨è -->
  <div class="card">
    <h2>â‘¡ ç”Ÿæˆæ¨èèœ </h2>

    <label for="ingredients">å¯é€‰ï¼šé¢å¤–è¾“å…¥é£Ÿæï¼ˆä¸ç”¨æ ‡ç‚¹ä¹Ÿè¡Œï¼Œç”¨ç©ºæ ¼/é€—å·éƒ½è¡Œï¼‰</label>
    <input id="ingredients" placeholder="ä¾‹å¦‚ï¼šé¸¡è›‹ æ´‹è‘±ï¼ˆå¯ä¸å¡«ï¼Œé»˜è®¤ç”¨åº“å­˜ï¼‰" />

    <button id="btn">ç”Ÿæˆæ¨èèœå“</button>

    <div class="result" id="output"></div>
    <ul id="list"></ul>
    <div class="hint" id="hint"></div>
  </div>

  <script>
    // ========== â€œæ•°æ®åº“â€ï¼šlocalStorage ==========
    const INV_KEY = "kitchen_inventory_v1";

    function loadInventory() {
      try {
        const raw = localStorage.getItem(INV_KEY);
        if (!raw) return {};
        return JSON.parse(raw);
      } catch {
        return {};
      }
    }

    function saveInventory(invObj) {
      localStorage.setItem(INV_KEY, JSON.stringify(invObj));
    }

    function daysLeft(expDateStr) {
      if (!expDateStr) return 9999;
      const today = new Date();
      const exp = new Date(expDateStr + "T00:00:00");
      const diffMs = exp.getTime() - new Date(today.toDateString()).getTime();
      return Math.floor(diffMs / (1000 * 60 * 60 * 24));
    }

    function renderInventoryTable() {
      const inv = loadInventory();
      const body = document.getElementById("invTableBody");
      body.innerHTML = "";

      const names = Object.keys(inv).sort((a, b) => a.localeCompare(b, "zh"));
      if (names.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5" class="small">æš‚æ— åº“å­˜ã€‚è¯·å…ˆå½•å…¥é£Ÿæ/æ•°é‡/ä¿è´¨æœŸã€‚</td>`;
        body.appendChild(tr);
        return;
      }

      names.forEach(name => {
        const item = inv[name];
        const dl = daysLeft(item.expiresAt);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${name}</td>
          <td>${item.qty}</td>
          <td>${item.expiresAt || "-"}</td>
          <td>${dl === 9999 ? "-" : dl}</td>
          <td><button data-del="${name}">åˆ é™¤</button></td>
        `;
        body.appendChild(tr);
      });

      // delete handlers
      body.querySelectorAll("button[data-del]").forEach(btn => {
        btn.addEventListener("click", () => {
          const name = btn.getAttribute("data-del");
          const inv2 = loadInventory();
          delete inv2[name];
          saveInventory(inv2);
          renderInventoryTable();
        });
      });
    }

    // ========== è¾“å…¥è§£æï¼ˆå…è®¸æ— æ ‡ç‚¹ï¼‰ ==========
    function normalizeInput(text) {
      return text
        .replace(/[0-9]/g, "")
        .replace(/å’Œ|ä¸/g, " ")
        .replace(/[^\u4e00-\u9fa5]/g, " ")
        .split(" ")
        .map(s => s.trim())
        .filter(Boolean);
    }

    // ========== èœè°±è¯»å– ==========
    async function loadRecipes() {
      const res = await fetch("./recipes.json");
      if (!res.ok) throw new Error("æ— æ³•è¯»å– recipes.json");
      return await res.json();
    }

    // ========== æ¨èè¯„åˆ†è§„åˆ™ ==========
    // ä½ çš„åŸåˆ™ï¼š
    // 1) ä¸´è¿‘ä¿è´¨æœŸä¼˜å…ˆ
    // 2) æ•°é‡å¤šä¼˜å…ˆ
    // 3) é£Ÿæå°‘ï¼ˆç®€å•ï¼‰ä¼˜å…ˆ
    //
    // å®ç°æ–¹æ³•ï¼ˆMVPï¼‰ï¼š
    // - å¯¹æ¯é“å€™é€‰èœï¼Œè®¡ç®—ï¼š
    //   earliestExpiryDaysUsedï¼šè¯¥èœä½¿ç”¨åˆ°çš„åº“å­˜é£Ÿæä¸­ï¼Œæœ€å°å‰©ä½™å¤©æ•°ï¼ˆè¶Šå°è¶Šä¼˜å…ˆï¼‰
    //   totalQtyUsed: è¯¥èœä½¿ç”¨åˆ°çš„åº“å­˜é£Ÿææ•°é‡åˆè®¡ï¼ˆè¶Šå¤§è¶Šä¼˜å…ˆï¼‰
    //   recipeIngredientCount: èœçš„ä¸»é£Ÿææ•°ï¼ˆè¶Šå°è¶Šä¼˜å…ˆï¼‰
    //
    // æ’åºï¼šearliestExpiryDaysUsed â†‘, totalQtyUsed â†“, recipeIngredientCount â†‘
    function scoreRecipe(recipe, inv, extraSet) {
      // è¿™é“èœâ€œç”¨åˆ°çš„é£Ÿæâ€= recipe.ingredients
      // å¯ç”¨é£Ÿæé›†åˆ = åº“å­˜æœ‰ qty>0 çš„ + é¢å¤–è¾“å…¥
      const available = new Set(Object.keys(inv).filter(k => inv[k].qty > 0));
      for (const x of extraSet) available.add(x);

      const missing = recipe.ingredients.filter(ing => !available.has(ing));
      const missingCount = missing.length;

      // ç”¨åˆ°çš„åº“å­˜é£Ÿæï¼ˆä»…åº“å­˜éƒ¨åˆ†ï¼Œç”¨äºç®—ä¿è´¨æœŸ/æ•°é‡ï¼‰
      const usedFromInv = recipe.ingredients.filter(ing => inv[ing] && inv[ing].qty > 0);

      let earliest = 9999;
      let qtySum = 0;
      usedFromInv.forEach(ing => {
        earliest = Math.min(earliest, daysLeft(inv[ing].expiresAt));
        qtySum += Number(inv[ing].qty || 0);
      });

      // å¦‚æœå®Œå…¨æ²¡ç”¨åˆ°åº“å­˜ï¼Œåªç”¨é¢å¤–è¾“å…¥ï¼ˆä¾‹å¦‚ä½ æ‰‹åŠ¨è¾“å…¥äº†æŸé£Ÿæä½†åº“å­˜æ²¡å½•ï¼‰ï¼Œ
      // é‚£ä¹ˆ earliest/qtySum è®¾ä¸ºä¸ä¼˜å…ˆï¼ˆMVPç­–ç•¥ï¼‰
      if (usedFromInv.length === 0) {
        earliest = 9999;
        qtySum = 0;
      }

      return {
        missing,
        missingCount,
        usedFromInv,
        earliestExpiryDaysUsed: earliest,
        totalQtyUsed: qtySum,
        recipeIngredientCount: recipe.ingredients.length
      };
    }

    // ========== æ‰£åº“å­˜ï¼ˆç‚¹å‡»èœå“åï¼‰ ==========
    function consumeRecipe(recipe) {
      const inv = loadInventory();

      // æ‰¾å‡ºéœ€è¦æ‰£å‡çš„â€œåº“å­˜é£Ÿæâ€ï¼ˆåªå¯¹åº“å­˜é‡Œå­˜åœ¨çš„é£Ÿææ‰£ï¼‰
      const need = recipe.ingredients.filter(ing => inv[ing] && inv[ing].qty > 0);
      if (need.length === 0) {
        alert("è¿™é“èœæ²¡æœ‰å¯æ‰£å‡çš„åº“å­˜é£Ÿæï¼ˆå¯èƒ½ä½ æ²¡å½•å…¥åº“å­˜ï¼‰ã€‚");
        return;
      }

      // ç®€åŒ–ï¼šé»˜è®¤æ¯ç§é£Ÿææ¶ˆè€— 1 å•ä½ï¼›ç”¨æˆ·å¯é€ä¸ªç¡®è®¤/ä¿®æ”¹
      const consumePlan = {};
      for (const ing of need) {
        const max = inv[ing].qty;
        const input = prompt(`ã€${recipe.name}ã€‘\nè¯·è¾“å…¥è¦æ¶ˆè€—çš„ã€${ing}ã€‘æ•°é‡ï¼ˆåº“å­˜å‰©ä½™ ${max}ï¼‰ï¼š`, "1");
        if (input === null) return; // ç”¨æˆ·å–æ¶ˆ
        const n = parseInt(input, 10);
        if (!Number.isFinite(n) || n <= 0) {
          alert("æ•°é‡å¿…é¡»æ˜¯æ­£æ•´æ•°ã€‚å·²å–æ¶ˆæ‰£å‡ã€‚");
          return;
        }
        if (n > max) {
          alert(`ã€${ing}ã€‘æ¶ˆè€—æ•°é‡ä¸èƒ½è¶…è¿‡åº“å­˜ï¼ˆ${max}ï¼‰ã€‚å·²å–æ¶ˆæ‰£å‡ã€‚`);
          return;
        }
        consumePlan[ing] = n;
      }

      // æ‰£å‡
      for (const ing of Object.keys(consumePlan)) {
        inv[ing].qty -= consumePlan[ing];
        if (inv[ing].qty < 0) inv[ing].qty = 0;
      }
      saveInventory(inv);

      renderInventoryTable();

      // æ˜¾ç¤ºå‰©ä½™
      const lines = Object.keys(consumePlan).map(ing => `- ${ing}ï¼šæ¶ˆè€— ${consumePlan[ing]}ï¼Œå‰©ä½™ ${inv[ing].qty}`);
      alert(`æ‰£å‡å®Œæˆï¼š\n${lines.join("\n")}`);
    }

    // ========== äº‹ä»¶ï¼šæ·»åŠ åº“å­˜ ==========
    document.getElementById("addInvBtn").addEventListener("click", () => {
      const name = document.getElementById("invName").value.trim();
      const qtyStr = document.getElementById("invQty").value.trim();
      const exp = document.getElementById("invExp").value;

      const status = document.getElementById("invStatus");
      status.textContent = "";

      if (!name) { status.textContent = "è¯·è¾“å…¥é£Ÿæåç§°ã€‚"; return; }
      const qty = parseInt(qtyStr, 10);
      if (!Number.isFinite(qty) || qty <= 0) { status.textContent = "æ•°é‡å¿…é¡»æ˜¯æ­£æ•´æ•°ã€‚"; return; }

      const inv = loadInventory();

      if (!inv[name]) {
        inv[name] = { qty, expiresAt: exp || "" };
      } else {
        // åˆå¹¶æ•°é‡
        inv[name].qty = Number(inv[name].qty || 0) + qty;

        // åˆ°æœŸæ—¥å–æ›´è¿‘çš„ï¼ˆå¦‚æœä¸¤è€…éƒ½æœ‰ï¼‰
        if (exp && inv[name].expiresAt) {
          const d1 = daysLeft(inv[name].expiresAt);
          const d2 = daysLeft(exp);
          inv[name].expiresAt = (d2 < d1) ? exp : inv[name].expiresAt;
        } else if (exp && !inv[name].expiresAt) {
          inv[name].expiresAt = exp;
        }
      }

      saveInventory(inv);
      renderInventoryTable();

      status.textContent = `å·²å†™å…¥ï¼š${name} +${qty}ï¼ˆåˆ°æœŸï¼š${exp || "æœªå¡«"}ï¼‰`;
      document.getElementById("invName").value = "";
      document.getElementById("invQty").value = "";
      document.getElementById("invExp").value = "";
    });

    document.getElementById("clearInvBtn").addEventListener("click", () => {
      if (!confirm("ç¡®å®šè¦æ¸…ç©ºåº“å­˜å—ï¼Ÿ")) return;
      localStorage.removeItem(INV_KEY);
      renderInventoryTable();
      document.getElementById("invStatus").textContent = "åº“å­˜å·²æ¸…ç©ºã€‚";
    });

    // ========== äº‹ä»¶ï¼šç”Ÿæˆæ¨è ==========
    document.getElementById("btn").addEventListener("click", async () => {
      const output = document.getElementById("output");
      const hint = document.getElementById("hint");
      const list = document.getElementById("list");
      output.textContent = "å¤„ç†ä¸­...";
      hint.textContent = "";
      list.innerHTML = "";

      const inv = loadInventory();
      const invSet = new Set(Object.keys(inv).filter(k => inv[k].qty > 0));

      const inputText = document.getElementById("ingredients").value;
      const extra = new Set(normalizeInput(inputText));

      // å¯ç”¨é£Ÿæä¸ºç©ºåˆ™æç¤º
      if (invSet.size === 0 && extra.size === 0) {
        output.textContent = "";
        hint.textContent = "è¯·å…ˆå½•å…¥åº“å­˜ï¼Œæˆ–åœ¨ä¸Šæ–¹è¾“å…¥é¢å¤–é£Ÿæã€‚";
        return;
      }

      try {
        const recipes = await loadRecipes();

        // è§„åˆ™ï¼šå…è®¸ç¼º 1 ä¸ªä¸»é£Ÿæä¹Ÿæ¨èï¼ˆæ²¿ç”¨ä½ ç°åœ¨çš„ç­–ç•¥ï¼‰ï¼Œä½†è¿™é‡Œæ”¹æˆâ€œåŸºäºåº“å­˜/é¢å¤–è¾“å…¥â€
        const candidates = recipes
          .map(r => {
            const s = scoreRecipe(r, inv, extra);
            // å¿…é¡»è‡³å°‘ç”¨åˆ°ä¸€ä¸ªâ€œå¯ç”¨é£Ÿæâ€ï¼ˆå¦åˆ™æ˜¯æ— å…³èœï¼‰
            const available = new Set([...invSet, ...extra]);
            const usedFromAvailable = r.ingredients.filter(ing => available.has(ing));
            return { recipe: r, ...s, usedFromAvailable, usedCount: usedFromAvailable.length };
          })
          .filter(x => x.usedCount >= 1)
          .filter(x => x.missingCount <= 1);

        if (candidates.length === 0) {
          output.textContent = "æœªæ‰¾åˆ°å¯æ¨èèœå“";
          hint.textContent = "è§„åˆ™ï¼šåªæ¨èç¼º 0 æˆ–ç¼º 1 ä¸ªä¸»é£Ÿæï¼Œä¸”å¿…é¡»ç”¨åˆ°ä½ ç°æœ‰çš„é£Ÿæã€‚";
          return;
        }

        // æŒ‰ä½ çš„ä¸‰æ¡åŸåˆ™æ’åº
        candidates.sort((a, b) => {
          // å…ˆï¼šç¼ºå¾—å°‘ï¼ˆç¼º0ä¼˜å…ˆï¼‰ï¼Œä¿è¯â€œèƒ½åšâ€ä¼˜å…ˆ
          if (a.missingCount !== b.missingCount) return a.missingCount - b.missingCount;
          // 1) ä¸´è¿‘ä¿è´¨æœŸä¼˜å…ˆï¼ˆearliest è¶Šå°è¶Šé å‰ï¼‰
          if (a.earliestExpiryDaysUsed !== b.earliestExpiryDaysUsed) return a.earliestExpiryDaysUsed - b.earliestExpiryDaysUsed;
          // 2) æ•°é‡å¤šä¼˜å…ˆï¼ˆqtySum è¶Šå¤§è¶Šé å‰ï¼‰
          if (a.totalQtyUsed !== b.totalQtyUsed) return b.totalQtyUsed - a.totalQtyUsed;
          // 3) é£Ÿæå°‘ä¼˜å…ˆï¼ˆè¶Šç®€å•è¶Šé å‰ï¼‰
          return a.recipeIngredientCount - b.recipeIngredientCount;
        });

        const top5 = candidates.slice(0, 5);
        output.textContent = "æ¨èèœå“ï¼ˆç‚¹å‡»å¯æ‰£åº“å­˜ï¼Œæœ€å¤š 5 ä¸ªï¼‰ï¼š";

        top5.forEach((item, index) => {
          const li = document.createElement("li");

          const r = item.recipe;
          const missingText = item.missingCount === 0 ? "âœ… é£Ÿæé½å…¨" : `âš ï¸ ç¼ºï¼š${item.missing[0]}`;
          const expiryText = (item.earliestExpiryDaysUsed === 9999) ? "åˆ°æœŸï¼š-" : `æœ€æ—©åˆ°æœŸï¼š${item.earliestExpiryDaysUsed} å¤©`;
          const qtyText = `åº“å­˜æ•°é‡ä¼˜å…ˆå€¼ï¼š${item.totalQtyUsed}`;
          const simpleText = `ä¸»é£Ÿææ•°ï¼š${r.ingredients.length}`;

          // è¾“å‡º name, ingredients, seasonings
          li.innerHTML = `
            <div>
              <strong>${index + 1}. ${r.name}</strong>
              <span class="pill">${missingText}</span>
              <span class="pill">${expiryText}</span>
              <span class="pill">${qtyText}</span>
              <span class="pill">${simpleText}</span>
            </div>
            <div class="small"><b>Ingredients</b>ï¼š${r.ingredients.join("ã€")}</div>
            <div class="small"><b>Seasonings</b>ï¼š${(r.seasonings || []).join("ã€")}</div>
          `;

          // ç‚¹å‡»æ‰£åº“å­˜ï¼ˆä»…å½“é£Ÿæé½å…¨æ—¶æ›´åˆç†ï¼›ä½ ä¹Ÿå¯ä»¥å…è®¸ç¼º1çš„å…ˆæç¤ºï¼‰
          li.style.cursor = "pointer";
          li.addEventListener("click", () => {
            if (item.missingCount > 0) {
              alert(`è¿™é“èœè¿˜ç¼ºï¼š${item.missing[0]}ã€‚\nå»ºè®®å…ˆè¡¥é½å†æ‰£åº“å­˜ã€‚`);
              return;
            }
            consumeRecipe(r);
          });

          list.appendChild(li);
        });

        hint.textContent = "æ’åºåŸåˆ™ï¼šå…ˆèƒ½åšï¼ˆç¼º0ä¼˜å…ˆï¼‰ï¼Œå†æŒ‰æœ€æ—©åˆ°æœŸâ†‘ã€æ•°é‡ä¼˜å…ˆâ†“ã€ä¸»é£Ÿææ•°â†‘ã€‚ç‚¹å‡»èœåå¯æ‰£åº“å­˜å¹¶æ˜¾ç¤ºå‰©ä½™ã€‚";
      } catch (e) {
        output.textContent = "å‡ºé”™äº†";
        hint.textContent = e.message;
      }
    });

    // åˆå§‹æ¸²æŸ“åº“å­˜
    renderInventoryTable();

    // ================== è¯­éŸ³ Agentï¼šASR + TTS + çŠ¶æ€æœºï¼ˆMVPï¼‰ ==================
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const hasASR = !!SpeechRecognition;
    const hasTTS = "speechSynthesis" in window;
    
    const micBtn = document.getElementById("micBtn");
    const stopBtn = document.getElementById("stopBtn");
    const userUtterEl = document.getElementById("userUtter");
    const aiUtterEl = document.getElementById("aiUtter");
    
    let recog = null;
    let state = "IDLE"; // IDLE | ASK_INV | RECOMMEND | ASK_MORE | CONFIRM_DEDUCT
    let pendingChosenRecipe = null; // {name, ingredients, seasonings}
    let lastTop5 = []; // è®°å½•æœ€è¿‘ä¸€æ¬¡æ¨èï¼Œä¾¿äºâ€œæˆ‘é€‰ç¬¬2ä¸ªâ€
    
    function speakCN(text) {
      aiUtterEl.textContent = text;
      if (!hasTTS) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "zh-CN";
      u.rate = 1.0;  // æ¸©æŸ”ï¼šå¯ä»¥ 0.95
      u.pitch = 1.0;
      window.speechSynthesis.speak(u);
    }
    
    function startRecog() {
      if (!hasASR) {
        speakCN("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ã€‚è¯·ç”¨ Chrome æˆ– Edgeã€‚");
        return;
      }
      if (recog) return;
    
      recog = new SpeechRecognition();
      recog.lang = "zh-CN";
      recog.interimResults = false;
      recog.continuous = false;
    
      recog.onresult = (e) => {
        const txt = e.results[0][0].transcript.trim();
        userUtterEl.textContent = txt;
        handleUtterance(txt);
      };
      recog.onerror = () => {
        speakCN("æˆ‘æ²¡æœ‰å¬æ¸…æ¥šã€‚è¯·å†è¯´ä¸€éã€‚");
        stopRecog();
      };
      recog.onend = () => {
        stopRecog();
      };
    
      recog.start();
    }
    
    function stopRecog() {
      if (!recog) return;
      try { recog.stop(); } catch {}
      recog = null;
    }
    
    // ---- æ„å›¾è¯†åˆ«ï¼ˆMVP å…ˆç”¨å…³é”®è¯è§„åˆ™ï¼›åç»­å¯æ¢ LLMï¼‰ ----
    function hasAny(txt, arr) { return arr.some(k => txt.includes(k)); }
    
    function parseIntent(txt) {
      // ä½ å®šä¹‰çš„å…³é”®è¯
      if (hasAny(txt, ["åšé¥­","åšèœ","ç‚’èœ","é¥­","èœ","ä»Šå¤©åƒ","æ¨è"])) return "START_COOK";
      if (hasAny(txt, ["æ›´å¤šé£Ÿæ","æ–°é£Ÿæ","å†åŠ ","è¡¥å……"])) return "ADD_MORE";
      if (hasAny(txt, ["æˆ‘é€‰","æˆ‘ä»Šå¤©åš","å°±åš","é€‰è¿™ä¸ª","åšè¿™ä¸ª"])) return "CHOOSE";
      if (hasAny(txt, ["å¯ä»¥","è¡Œ","å¥½çš„","ok","OK","æ˜¯","ç¡®è®¤"])) return "YES";
      if (hasAny(txt, ["ä¸","ä¸è¦","ç®—äº†","å–æ¶ˆ"])) return "NO";
      return "OTHER";
    }
    
    // ---- ä»è¯­å¥é‡Œç²—ç•¥æŠ½å–ï¼šé£Ÿæã€æ•°é‡ã€æ—¥æœŸï¼ˆMVPï¼šæ ¼å¼åŒ–å¼•å¯¼ç”¨æˆ·è¯´æ¸…æ¥šï¼‰ ----
    function tryExtractInventory(txt) {
      // å»ºè®®ç”¨æˆ·æŒ‰ï¼šé£Ÿæxx æ•°é‡xx åˆ°æœŸxx è¯´
      // è¿™é‡Œåšä¸€ä¸ªéå¸¸ä¿å®ˆçš„æŠ½å–ï¼šåªæŠ“â€œé£Ÿæ/æ•°é‡/åˆ°æœŸâ€å…³é”®è¯åé¢çš„å†…å®¹
      // ä¾‹ï¼šé£Ÿæé¸¡è›‹ æ•°é‡6 åˆ°æœŸ2026-01-10
      const mName = txt.match(/é£Ÿæ\s*([^\s]+)/);
      const mQty = txt.match(/æ•°é‡\s*([0-9]+)/);
      const mExp = txt.match(/åˆ°æœŸ\s*([0-9]{4}-[0-9]{2}-[0-9]{2})/);
      return {
        name: mName ? mName[1] : "",
        qty: mQty ? parseInt(mQty[1], 10) : NaN,
        exp: mExp ? mExp[1] : ""
      };
    }
    
    // ---- è°ƒç”¨ä½ ç°æœ‰çš„åº“å­˜å†™å…¥é€»è¾‘ï¼ˆå¤ç”¨ saveInventory + daysLeft çš„è§„åˆ™ï¼‰ ----
    function upsertInventory(name, qty, exp) {
      const inv = loadInventory();
      if (!inv[name]) {
        inv[name] = { qty, expiresAt: exp || "" };
      } else {
        inv[name].qty = Number(inv[name].qty || 0) + qty;
        if (exp && inv[name].expiresAt) {
          const d1 = daysLeft(inv[name].expiresAt);
          const d2 = daysLeft(exp);
          inv[name].expiresAt = (d2 < d1) ? exp : inv[name].expiresAt;
        } else if (exp && !inv[name].expiresAt) {
          inv[name].expiresAt = exp;
        }
      }
      saveInventory(inv);
      renderInventoryTable();
    }
    
    // ---- å¤ç”¨ä½ ç°æœ‰æ¨èæŒ‰é’®é€»è¾‘ï¼šè¿™é‡Œç›´æ¥è§¦å‘ç‚¹å‡»ï¼Œè®©é¡µé¢ç”Ÿæˆ top5 ----
    async function recommendTop5ByAgent(extraText = "") {
      // å°†é¢å¤–é£Ÿæå†™å…¥è¾“å…¥æ¡†ï¼Œç„¶åè§¦å‘æŒ‰é’®
      const input = document.getElementById("ingredients");
      input.value = extraText;
      document.getElementById("btn").click();
    
      // ä» DOM æŠ“å–æœ€æ–°çš„ top5ï¼ˆåŸºäºä½ ç°åœ¨ li è¾“å‡ºç»“æ„ï¼‰
      // ä¸ºäº†ç¨³å®šï¼Œåšä¸€ä¸ªå»¶æ—¶ç­‰å¾…æ¸²æŸ“å®Œæˆ
      await new Promise(r => setTimeout(r, 400));
    
      const lis = Array.from(document.querySelectorAll("#list li"));
      lastTop5 = lis.slice(0, 5).map(li => li.innerText);
    
      // ç»™è¯­éŸ³æ’­æŠ¥ä¸€ä¸ªæ›´çŸ­çš„ç‰ˆæœ¬ï¼šåªè¯»èœå
      const names = lis.slice(0, 5).map(li => {
        const m = li.innerText.match(/^\s*\d+\.\s*([^\nâœ…âš ï¸]+)/);
        return m ? m[1].trim() : li.innerText.slice(0, 20);
      });
    
      speakCN(`æˆ‘ç»™æ‚¨æ¨èäº†${names.length}ä¸ªèœï¼š${names.join("ï¼Œ")}ã€‚æ‚¨æƒ³åšå“ªä¸€ä¸ªï¼Ÿå¯ä»¥è¯´ï¼šæˆ‘é€‰ç¬¬1ä¸ªï¼Œæˆ–æˆ‘é€‰èœåã€‚`);
      state = "CONFIRM_DEDUCT";
    }
    
    // ---- æ ¹æ®â€œæˆ‘é€‰ç¬¬2ä¸ª/æˆ‘é€‰xxxâ€å®šä½å¯¹åº”èœï¼ˆMVPï¼šä»åˆ—è¡¨æ–‡æœ¬åŒ¹é…ï¼‰ ----
    function pickFromTop5(txt) {
      // 1) é€‰ç¬¬Nä¸ª
      const m = txt.match(/ç¬¬\s*([1-5])\s*ä¸ª/);
      if (m) {
        const idx = parseInt(m[1], 10) - 1;
        return { idx, raw: lastTop5[idx] || "" };
      }
      // 2) åŒ…å«æŸä¸ªèœåå…³é”®å­—ï¼šåœ¨ lastTop5 ä¸­æ‰¾
      const hit = lastTop5.find(x => txt.includes(x.split("âœ…")[0].split("âš ï¸")[0].trim().replace(/^\d+\.\s*/, "")));
      if (hit) return { idx: lastTop5.indexOf(hit), raw: hit };
      return null;
    }
    
    // ---- è¯­éŸ³ä¸»æ§ï¼šæŒ‰ä½ çš„ä¸‰æ®µå¿…è¦äº’åŠ¨æ¥èµ° ----
    function handleUtterance(txt) {
      const intent = parseIntent(txt);
    
      // åˆæ¬¡ï¼šä»»ä½•â€œåšé¥­/åšèœ/æ¨èâ€è¿›å…¥æµç¨‹
      if (state === "IDLE") {
        if (intent === "START_COOK") {
          const inv = loadInventory();
          const hasInv = Object.keys(inv).some(k => inv[k].qty > 0);
          if (!hasInv) {
            state = "ASK_INV";
            speakCN("å¥½çš„ã€‚æˆ‘éœ€è¦å…ˆäº†è§£å†°ç®±åº“å­˜ã€‚è¯·æŒ‰è¿™ä¸ªæ ¼å¼è¯´ï¼šé£Ÿæ é¸¡è›‹ï¼Œæ•°é‡ 6ï¼Œåˆ°æœŸ 2026-01-10ã€‚ä¸€æ¬¡è¯´ä¸€ç§é£Ÿæã€‚");
          } else {
            state = "RECOMMEND";
            speakCN("å¥½çš„ï¼Œæˆ‘å·²è¯»å–åˆ°æ‚¨çš„å†°ç®±åº“å­˜ã€‚ç°åœ¨ä¸ºæ‚¨æ¨è5ä¸ªèœã€‚");
            recommendTop5ByAgent("");
          }
          return;
        }
        speakCN("æˆ‘æ˜¯AIå¨æˆ¿åŠ©æ‰‹ã€‚æ‚¨å¯ä»¥è¯´ï¼šæˆ‘æƒ³åšé¥­ï¼Œæˆ–è€…æ¨èå‡ é“èœã€‚");
        return;
      }
    
      // äº’åŠ¨1ï¼šå½•å…¥åº“å­˜ï¼ˆæœ¬åœ°å·²æœ‰åˆ™è·³è¿‡ï¼‰
      if (state === "ASK_INV") {
        const extracted = tryExtractInventory(txt);
        if (!extracted.name || !Number.isFinite(extracted.qty) || extracted.qty <= 0 || !extracted.exp) {
          speakCN("æˆ‘è¿˜éœ€è¦å®Œæ•´ä¿¡æ¯ï¼šé£Ÿæã€æ•°é‡ã€åˆ°æœŸæ—¥ã€‚è¯·æŒ‰ï¼šé£Ÿæ é¸¡è›‹ æ•°é‡ 6 åˆ°æœŸ 2026-01-10 è¿™æ ·è¯´ã€‚");
          return;
        }
        upsertInventory(extracted.name, extracted.qty, extracted.exp);
        speakCN(`å·²è®°å½•ï¼š${extracted.name} æ•°é‡${extracted.qty}ï¼Œåˆ°æœŸ${extracted.exp}ã€‚æ‚¨è¿˜è¦ç»§ç»­æ·»åŠ å—ï¼Ÿå¦‚æœè¦æ·»åŠ ï¼Œè¯·è¯´ï¼šæ›´å¤šé£Ÿæã€‚å¦åˆ™æˆ‘å°†ä¸ºæ‚¨æ¨è5ä¸ªèœã€‚`);
        state = "RECOMMEND";
        return;
      }
    
      // äº’åŠ¨2ï¼šæ¨èï¼ˆå¦‚æœç”¨æˆ·è¯´æ›´å¤šé£Ÿæ => äº’åŠ¨3ï¼‰
      if (state === "RECOMMEND") {
        if (intent === "ADD_MORE") {
          state = "ASK_MORE";
          speakCN("å¥½çš„ï¼Œè¯·ç»§ç»­æŒ‰æ ¼å¼è¯´ï¼šé£Ÿæ å«ä»€ä¹ˆï¼Œæ•°é‡ å¤šå°‘ï¼Œåˆ°æœŸ æ—¥æœŸã€‚");
          return;
        }
        // é»˜è®¤ç›´æ¥æ¨è
        recommendTop5ByAgent("");
        return;
      }
    
      // äº’åŠ¨3ï¼šæ–°å¢é£Ÿæå¹¶å†æ¬¡æ¨è
      if (state === "ASK_MORE") {
        const extracted = tryExtractInventory(txt);
        if (!extracted.name || !Number.isFinite(extracted.qty) || extracted.qty <= 0 || !extracted.exp) {
          speakCN("è¯·è¡¥å…¨ï¼šé£Ÿæã€æ•°é‡ã€åˆ°æœŸæ—¥ã€‚ç¤ºä¾‹ï¼šé£Ÿæ è¥¿çº¢æŸ¿ æ•°é‡ 3 åˆ°æœŸ 2026-01-06ã€‚");
          return;
        }
        upsertInventory(extracted.name, extracted.qty, extracted.exp);
        speakCN(`å·²æ–°å¢ï¼š${extracted.name} æ•°é‡${extracted.qty}ï¼Œåˆ°æœŸ${extracted.exp}ã€‚ç°åœ¨æˆ‘ç»“åˆå…¨éƒ¨åº“å­˜å†æ¨è5ä¸ªèœã€‚`);
        recommendTop5ByAgent("");
        return;
      }
    
      // é€‰æ‹©ä¸æ‰£åº“å­˜ç¡®è®¤
      if (state === "CONFIRM_DEDUCT") {
        // ç”¨æˆ·è¯´â€œæˆ‘é€‰â€¦â€
        if (intent === "CHOOSE") {
          const picked = pickFromTop5(txt);
          if (!picked || !picked.raw) {
            speakCN("æˆ‘æ²¡è¯†åˆ«åˆ°æ‚¨é€‰çš„æ˜¯å“ªä¸€ä¸ªã€‚è¯·è¯´ï¼šæˆ‘é€‰ç¬¬1ä¸ªï¼Œæˆ–ç›´æ¥è¯´èœåã€‚");
            return;
          }
          pendingChosenRecipe = picked.raw;
          speakCN("å¥½çš„ã€‚éœ€è¦æˆ‘å¸®æ‚¨ä»å†°ç®±åº“å­˜é‡Œæ‰£å‡ç›¸åº”é£Ÿææ•°é‡å—ï¼Ÿæ‚¨å¯ä»¥è¯´ï¼šå¯ä»¥ æˆ– ä¸è¦ã€‚");
          return;
        }
    
        // ç”¨æˆ·åŒæ„æ‰£å‡
        if (intent === "YES") {
          // MVPï¼šæˆ‘ä»¬æ— æ³•ä» raw æ–‡æœ¬å‡†ç¡®è¿˜åŸ recipe å¯¹è±¡ï¼Œå› æ­¤ç”¨é¡µé¢ç‚¹å‡»æ¥æ‰£å‡æœ€ç¨³ï¼š
          // è®©ç”¨æˆ·ç›´æ¥ç‚¹å‡»åˆ—è¡¨ä¸­çš„èœåå®Œæˆæ‰£å‡ï¼ˆä½ å·²æœ‰ consumeRecipe é€»è¾‘ï¼‰
          speakCN("å¥½çš„ã€‚è¯·åœ¨é¡µé¢ä¸Šç‚¹å‡»æ‚¨é€‰ä¸­çš„é‚£é“èœï¼Œæˆ‘ä¼šå¼•å¯¼æ‚¨è¾“å…¥æ¶ˆè€—æ•°é‡å¹¶æ˜¾ç¤ºå‰©ä½™ã€‚");
          return;
        }
    
        if (intent === "NO") {
          speakCN("å¥½çš„ï¼Œä¸æ‰£å‡åº“å­˜ã€‚å¦‚æœæ‚¨æƒ³æ·»åŠ æ–°é£Ÿæï¼Œè¯·è¯´ï¼šæ›´å¤šé£Ÿæã€‚");
          return;
        }
    
        if (intent === "ADD_MORE") {
          state = "ASK_MORE";
          speakCN("å¥½çš„ï¼Œè¯·è¯´æ–°å¢é£Ÿæï¼šé£Ÿæ åç§° æ•°é‡ æ•°å­— åˆ°æœŸ YYYY-MM-DDã€‚");
          return;
        }
    
        speakCN("æ‚¨å¯ä»¥è¯´ï¼šæˆ‘é€‰ç¬¬1ä¸ªï¼Œæˆ–æ›´å¤šé£Ÿæã€‚");
      }
    }
    
    // ç»‘å®šæŒ‰é’®
    micBtn.addEventListener("click", () => startRecog());
    stopBtn.addEventListener("click", () => {
      stopRecog();
      if (hasTTS) window.speechSynthesis.cancel();
    });
    
    // è¿›å…¥é¡µé¢æ—¶ï¼šAI æ¸©æŸ”å¼€åœº
    setTimeout(() => {
      speakCN("æˆ‘æ˜¯AIå¨æˆ¿åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆèƒ½å¸®æ‚¨ï¼Ÿæ‚¨å¯ä»¥è¯´ï¼šæˆ‘æƒ³åšé¥­ï¼Œæˆ–è€…æ¨èå‡ é“èœã€‚");
    }, 400);

    
  </script>
</body>
</html>
